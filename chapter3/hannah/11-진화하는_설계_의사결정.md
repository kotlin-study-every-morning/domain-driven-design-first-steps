### 11 진화하는 설계 의사결정

**도메인 변경**

들어가기전…

- 도메인 종류
    - 핵심
        - 기업이 경쟁 우위를 확보하기 위해 경쟁자와 다르게 수행하는 활동
    - 지원
        - 회사가 경쟁자와 다르게 하고 있지만 경쟁 우위를 제공하지 않는 활동
    - 일반
        - 모든 회사가 같은 방식으로 하는 일
- 실행 중인 하위 도메인 유형이 전략적 및 전술적 설계 의사결정에 영향을 미치는 것들
    - 바운디드 컨텍스트의 경계를 설계하는 방법
    - 컨텍스트 간의 연동을 조율하는 방법
    - 복잡한 비즈니스 로직을 다루기 위해 사용할 디자인 패턴

- 핵심에서 일반으로
    - 매출을 위한 회사의 솔루션(수단)을 다른 회사가 그 솔루션을 더 최적화하여 상용함으로서 핵심 하위 도메인이 일반 하위 도메인으로 변경
- 일반에서 핵심으로
    - 위와 반대로 상용 솔루션을 자체 구현으로 교체
- 지원에서 일반으로
    - 사용하던 기술이 오픈소스화되서 사내 솔루션을 버리고 오픈소스 솔루션과 연동
- 지원에서 핵심으로
    - 회사의 지출을 줄이거나 추가 수익을 창출하는 방식으로 지원 로직을 최적화하는것(하위 도메인의 비즈니스 로직이 점점 더 복잡해지는것)은 지원에서 핵심 도메인으로 변한다
- 핵심에서 지원으로
    - 하위 도메인의 복잡성이 정당화되지 않을 때 발생
    - 복잡성에 비해 수익성이 없는 경우
    - 하위 도메인의 개발을 지원하는 데 필요한 최소한의 로직만 남겨두고 불필요한 복잡성을 줄임
- 일반에서 지원으로
    - 다른 솔루션이 회사와 맞지 않다 사내 솔루션을 개발

![img_7.png](img_7.png)

**전략적 설계 문제**

- 핵심 하위 도메인
    - 충돌 방지 계층을 사용해서 모델을 보호
    - 사용자 - 제공자 관계 적합
- 지원 하위 도메인, 일반 하위 도메인
    - 분리형 노선



**전술적 설계 문제**

- 트랜잭션 스크립트에서 액티브 레코드로
    - 기본적으로 트랜잭션 스크립트와 액티브 레코드 패턴은 모두 절차지향 스크립트를 사용하여 비즈니스 로직 구현
    - 트랜잭션 스크립트에서 데이터 작업이 어려워지면 그것을 액티브 레코드 패턴으로 리팩터링
    1. 복잡한 자료구조를 찾아 액티브 레코드 객체에 캡슐화
    2. 데이터 베이스에 직접 접근하는 대신 액티브 레코드를 사용하며 모델과 구조 추상화
- 액티브 레코드에서 도메인 모델로
    - 액티브 레코드를 조작하는 비즈니스 로직이 점점 더 복잡해지고 불알치 및 중복 사례가 많아질 경우 도메인 모델 패턴으로 리펙터링
    1. VO 식별하기
    2. 자료구조를 분석하고 트랜잭션 경계 찾기
    3. 애그리게이트 찾기 : 모든 상태 수정 비즈니스 로직이 그에 상응하는 객체의 경계 내부로 이동할 때 비즈니스 규칙과 불변성을 지속적으로 확인하기 위해서 어떤 계층이 필요한지 검토
    4. 애그리게이트에 대해 루트 또는 퍼블릭 인터페이스의 엔드포인트 식별
- 도메인 모델에서 이벤트 소싱 도메인 모델로
    - 애그리게이트 경계가 적절하게 설계된 도메인 모델이 있으면 이벤트 소싱 모델로 전환
    - ‘이력이 없는’ 상태를 이벤트 기반 모델로 마이그레이션하는 것
- 전환에 필요한 과거 이력 생성
    - 애그리게이트를 위한 대략적인 이벤트 스트림 생성해서, 변환된 모델이 생성된 이벤트 스트림을 프로젝션해서 원래 구현과 동일한 상태 나타내게 함
    - 이벤트를 하나씩 적용하면 원래 시스템에서와 같이 정확한 상태 표현 방식으로 프로젝션
    - 이벤트 소싱을 사용하는 목표는 애그리게이트의 도메인 이벤트에 대해 안정적이고 강한 일관성을 가진 이력을 보유
    - 단점 : 접근 방식을 사용하면 상태 전환의 전체 히스토리를 복구하는 것은 불가능
- 마이그레이션 이벤트 모델링
    - 명시적으로 이벤트를 모델링 하는 방법
    - 현재 상태로 이어질 수 있는 모든 이벤트를 복구하는 대신 마이그레이션 이벤트를 정의하고 기존 애그리게이트 인스턴스의 이벤트 스트림을 초기화
    - 장점
        - 과거 데이터의 부족함을 명확히 한다
        - 그 누구도 이벤트 스트림이 애그리게이트 인스턴스의 수명주기 동안 발생한 모든 도메인 이벤트를 포착한다는 잘못된 추측을 할 수 없다
    - 단점
        - 레거시 시스템의 흔적이 이벤트 스토어에 영원히 남는다

**조직 변화**

- 파트너십에서 사용자 - 제공자
    - 팀이 멀리 이동하는 경우 파트너십 패턴에서 사용자 - 제공자 관계로 이동하는 것이 적절할 수도
- 사용자 - 제공자에서 분리형 노선으로
    - 팀내 불화가 있을 경우 서로의 꼬리를 쫓는 대신 기능을 복제하는 것이 더 비용 효과적일 수도

**도메인 지식**

- 음… 도메인 지식은 중요하다 (정리할 수 없음)

**성장**

> 성장은 시스템이 건강하다는 신호다. 새로운 기능이 지속해서 추가된다는 것은 시스템이 성공적이라는 신호다. 사용자에게 가치를 제공하고 사용자의 요구사항을 추가로 해결하고 경쟁 제품에 뒤지지 않게 확장한다는 뜻이다.

- 하위 도메인

  ![img_8.png](img_8.png)

    - 성장을 수용하기 위해 하위 도메인 경계를 최적화
- 바운디드 컨텍스트
    - 프로젝트가 발전하고 성장함에 따라 바운디드 컨텍스트가 초점을 잃고 다양한 문제와 관련된 로직이 늘어나는 것은 흔한 일이다
    - 성장은 기존의 암시적 설계 문제를 명확하게 만들 수 있다
    - 바운디드 컨텍스트의 경계를 재설계하여 바운디드 컨텍스트 각각의 자율성을 높여야한다
- 애그리게이트
    - 경험상 애그리게이트는 가능한 한 작게 유지하고, 비즈니스 도메인에서 강력하게 일과넞ㄱ인 상태를 유지해야하는 객체만 포함

**결론**

> 우리 인생에서 영원한 것은 변화한다는 사실뿐이다 - 헤라클레이토스


**연습 문제**

1. A
2. D
3. D
4. F
