### 06 복잡한 비즈니스 로직 다루기

**구성 요소**

1. Value Object
    - 복합적인 (composition) 값에 의해 식별되는 객체
        - ex: 같은 값을 갖는 두 개의 행을 만들 수 있게 하는 불필요한 ColorId 필드
    - 유비쿼터스 언어
        - 원시 데이터 타입에 전적으로 의존해서 비즈니스 도메인의 개념을 표현하는 것은 원시 집착 코드 징후(primitive obsession code smell)로 알려저 있다
        - 코드에서 유비쿼터스 언어를 사용하게 하므로 코드에서 비즈니스 도메인의 개념을 표현하게 된다
    - 클래스 구현시 설계 위험
        1. 유효성 검사 로직이 중복되기 쉽다
        2. 값이 사용되기 전에 유효성 검사 로직을 호출하게 하기 어렵다
        3. 다른 엔지니어가 코드베이스를 개선하는 것과 같은 미래를 대비한 유지보수가 어렵다
    - VO를 사용하여 설계 시
        1. 명료성이 향상 (짧은 변수 이름을 사용하더라도 의도를 명확하게 전달)
        2. 유효성 검사 로직이 VO 자체에 들어 있기 때문에 값을 할당하기 전에 유효성 검사를 할 필요가 없다
        3. 한곳에서 구현되고 쉽게 테스트 할 수 있다
    - VO를 사용하는 경우
        - VO는 가능한 모든 경우에 사용하는 게 좋다
            - 코드의 표현력 향상, 분산되기 쉬운 비즈니스 로직을 묶어줌, 코드 안전 향상, 불변이기 때문에 내포된 동작은 부작용과 동시성 문제 없음
        - 비즈니스 도메인 관점에서 유용한 법칙은 다른 객체의 속성을 표현하는 도메인의 요소 VO를 사용하는 것
2. Entity
    - 식별 필드의 핵심 요구사항은 각 엔티티의 인스턴스마다 고유해야 한다는 것
        - ex: 식별 필드를 제외한 다른 모든 필드의 값이 동일하더라도 인스턴스를 구분할 수 있게 해주는 명시적 식별자 필드의 도입
    - 엔티티는 모든 비즈니스 도메인의 필수 구성 요소
    - 엔티티를 단독으로 구현하지 않고 애그리게이트 패턴의 컨텍스트에서만 엔티티를 구현한다
3. Aggregate
    - Aggregate ≥ Entity
    - 이 패턴의 목적은 데이터의 일관성을 보호 → 일관성을 유지하기 위해 해결해야 할 과제가 있다는 의미 포함
    1. 일관성 강화
        - 애그리게이트는 일관성을 강화하는 경계
        - 모든 들어오는 변경 요청을 검사해서 그 변경이 애그리게이트의 비즈니스 규칙에 위배되지 않게 해야 한다
        - 커맨드
            - 뜻
                - 애그리게이트의 퍼블릭 인터페이스로 노출된 상태 변경 메서드 / 어떤 것을 지시하는 명령 (Entity.update()?…)
            - 구현
                - 애그리게이트 객체에 평범한 퍼블릭 메서드로 구현
                - 커맨드의 실행에 필요한 모든 입력값을 포함하는 파라미터 객체로 표현
        - 동시성 점검 (JPA의 @Version 이 있습니다…!)
            - 애그리게이트 데이터르 ㄹ저장하는 데 쓰이는 데이터베이스가 동시성 관리를 지원하는지 확인하는 것이 중요
    2. 트랜잭션 경계
        - 데이터 베이스 트랜잭션 하나당 한 개의 애그리게이트 → 애그리게이트의 경계가 비즈니스 도메인의 불변성과 규칙을 따르도록 신중히 설계하게 된다
    3. 엔티티 계층

       ![img.png](img.png)

        - 동일한 트랜잭션 경계에 속한 비즈니스 엔티티와 밸류 오브젝트를 한데 묶기 때문에 애그리게이트로 명명됐다
    4. 다른 애그리게이트 참조하기
        - 설계
            - 애그리게이트를 가능한 한 작게 유지
            - 애그리게이트의 비즈니스 로직에 따라 강력하게 일관적으로 상태를 유지할 필요가 있는 객체만 포함
        - 엔티티가 애그리게이트에 속하는지 판단하는 방법
            - 비즈니스 로직 내에 궁극적으로 일관된 데이터를 다루는 상황이 되면 시스템의 상태를 손상시킬 수 있는지 여부를 판단
            - 후, 그 비즈니스 로직이 애그리게이트에 있는지 여부를 조사
    5. 도메인 이벤트
        - 비즈니스 도메인에서 일어나는 중요한 이벤트를 설명하는 메시지
        - 목적
            - 비즈니스 도메인에서 일어난 일을 설명하고 이벤트와 고나련된 모든 필요한 데이터를 제공하는 것
            - 애그리게이트의 퍼블릭 인터페이스의 일부
    6. 유비쿼터스 언어
        - 애그리게이트는 유비쿼터스 언어를 사용해야한다
        - 애그리게이트의 이름, 데이터 멤버, 동작, 도메인 이벤트에 사용된 모든 용어는 모두 바운디드 컨텍스트의 유비쿼터스 언어로 명명
4. 도메인 서비스
    - 비즈니스 로직을 구현한 상태가 없는 객체(stateless object) / (Utills… Maker… Parser… etc.)
    - 여러 애그리게이트의 작업을 쉽게 조율할 수 있다
    - 애그리게이트의 데이터를 읽는 것이 필요한 계산 로직을 구현하는 것을 도와준다
    - 마이크로서비스, 서비스 지향 아키텍처 또는 소프트웨어 엔지니어링에서 ‘서비스’용어를 사용하는 대부분의 것과 아무런 상관이 없다는 점도 중요
    - 비즈니스 로직에서 사용되는 상태가 없는 객체일 뿐

**연습문제**

1. C
2. B
3. B
4. D
5. B
