### 커뮤니케이션 패턴

**모델 변환**

모델의 변환 로직은 스테이트리스 또는 스테이트풀이 될 수 있다

스테이트 변환(stateless translation)

- 상태를 보존하지 않은 변환
- 수신(OHS) 또는 발신(ACL) 요청이 발행할 때 즉석에서 발생

스테이트풀 변환(stateful translation)

- 상태 보존을 위해 데이터베이스를 사용하여 좀 더 복잡한 변환 로직을 다룰 수 있다

- 스테이리스 모델 변환
    - 모델 변환을 소유하는 다운디드 컨텍스트(업스트립의 경우 OHS, 다운스트림의 경우 ACL)는 프록시 디자인 패턴(proxy design pattern)을 구현하여 수신과 발신 요청을 삽입하고 소스 모델을 바운디드 컨텍스트의 목표 모델에 매핑한다
    - 동기
        - 바운디드 컨텍스트의 코드베이스에 변환 로직을 포함한다
        - 경우에 따라 변환 로직을 API 게이트웨이 패턴과 같은 외부 컴포넌트로 넘기는 것이 더 비용 효과적이고 편할 수 있다
        - 이러한 바운디드 컨텍스트는 주로 다른 컴포넌트에서 좀 더 편리하게 사용할 수 있게 모델을 변환하는 역할을 하며, 종종 교환 컨텍스트(interchange context)라고도 부른다
    - 비동기
        - 비동기 통신에 사용하는 모델을 변환하기 위해 메시지 프록시(message proxy)를 구현할 수 있다
        - 메시지 프록시는 소스 바운디드 컨텍스트에서 오는 메시지를 구독하는 중개 컴포넌트다
        - 프록시는 필요한 모델 변환을 적용하고 결과 메시지를 대상 구독자에게 전달
- 스테이트풀 모델 변환
    - 들어오는 데이터 집계하기
        - 유입되는 데이터를 집계하는 모델 변환은 API 게이트웨이를 사용하여 구현할 수 없으므로 좀 더 정교한 스테이트풀 처리가 필요
        - 일부 유스케이스에서는 상용 제품을 사용함으로써 스테이트풀 변환을 위한 맞춤 제작 솔루션을 구현하지 않은 경우도 있음 (kafka, AWS Kinesis etc.)
    - 여러 요청 통합의 예
        - 프론트엔드를 위한 백엔드 패턴
        - 여러 다른 컨텍스트의 데이터를 처리하고 이를 위해 복잡한 비즈니스 로직을 구현해야 하는 바운디드 컨텍스트

**애그리게이트 연동**

- 아웃 박스
    - 사용 알고리즘
        - 업데이트된 애그리게이트의 상태와 새 도메인 이벤트는 모두 동일한 원자성 트랜잭션으로 커밋
        - 메시지 릴레이는 데이터베이스에서 새로 커밋된 도메인 이벤트를 가져온다
        - 릴레이는 도메인 이벤트를 메시지 버스에 발행
        - 성공적으로 발행되면 릴레이는 이벤트를 데이터베이스에 발행한 것으로 표시하거나 완전히 삭제
    - 발행되지 않은 이벤트 가져오기
        - 발행 릴레이 : 풀(pull) 기반 또는 푸시(push) 기반 방식으로 새 도메인 이벤트를 가져올 수 있다
            - 풀 : 발행자 폴링
            - 푸시 : 트랜잭션 로그 추적
- 사가
    - 사가는 오래 지속되는 비즈니스 프로세스이다 즉, 여러 트랜잭션에 걸쳐 있는 비즈니스 프로세스를 말한다
    - 단순하고 선형적인 흐름을 관리, 엄밀히 말하면 사가는 이벤트를 해당 커맨드와 일치 시킨다

  ![Untitled](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/e3f65cf3-e4d2-46a3-a319-f73af7922e3b/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20230107%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20230107T090409Z&X-Amz-Expires=86400&X-Amz-Signature=8f1118539b3c7a446caa46f219639c25b02b1f4285ed326156fb3475191f9e9b&X-Amz-SignedHeaders=host&response-content-disposition=filename%3D%22Untitled.png%22&x-id=GetObject)

    - 일관성
        - 애그리게이트 경계 내의 데이터만 강한 일관성을 가진다 외부의 모든 것은 궁극적으로 일관성을 갖는다
        - 부적절한 애그리게이트 경계를 보상하기 위해 사가를 남용하지 않는 지침을 따르는 것을 원칙으로 하자
        - 사가 패턴은 종종 다른 패턴인 프로세스 관리자(process manger)와 혼동된다
- 프로세스 관리자

  ![Untitled](https://s3.us-west-2.amazonaws.com/secure.notion-static.com/fcafc60e-a5ed-49ff-9f2d-2e59173b6ce9/Untitled.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=AKIAT73L2G45EIPT3X45%2F20230107%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20230107T090427Z&X-Amz-Expires=86400&X-Amz-Signature=9dbe94c5a74f9596e13948f775c57513b8b4ac5a87c578e25e0087b2c043f709&X-Amz-SignedHeaders=host&response-content-disposition=filename%3D%22Untitled.png%22&x-id=GetObject)

    - 사가와 프로세스 관리자와의 차이점
        - 사가에 올바른 동작 과정을 선택하는 if-else 문이 포함되어 있다면 아마도 프로세스 관리자일 것
        - 사가는 특정 이벤트가 관찰될 때 사가가 암시적으로 인스턴스화 / 프로세스 관리자는 단일 소스 이벤트에 바인딩 될 수 없다

**결론**

- 모델 변환 패턴을 살펴보았다
- 아웃박스 패턴은 애그리게이트의 도메인 이벤트를 발행하는 안정적인 방법이다
- 사가 패턴은 간단한 교차 컴포넌트 비즈니스 프로세스를 구현하는 데 사용할 수 있다

**연습 문제**

1. D
2. B
3. 비동기 실행
4. E
